**Class:** `com.android.apksig.DefaultApkSignerEngine`

| Topic | Description |
|-------|-------------|
| **Main purpose / role** | `DefaultApkSignerEngine` is the **core implementation of the APK signing process**.  It implements the `ApkSignerEngine` interface and is responsible for: <br>1. **Configuring signers** for the four supported signing schemes (V1 → JAR signature block, V2 & V3 → APK signing block, V4 → APK v4 block).  <br>2. **Processing the input APK** – receiving the raw APK data, reading the manifest, collecting information about which entries are signed or need to be re‑signed, and deciding which signers apply to which entries.  <br>3. **Producing the signed output** – writing the various signature blocks, V1 JAR signatures, V2/V3 signing block, V4 block, and optional source‑stamp certificate.  <br>4. **Enforcing policy** – e.g., rejecting signatures for debug APKs when that is disallowed, preserving or discarding existing signatures, and handling “other signers” that are not part of the supplied config.  <br>5. **Thread‑safety and executor support** – it accepts a `RunnablesExecutor` so that the heavy cryptographic work can be performed asynchronously. |
| **Importance in the application** | **Core**.  This class is the *execution engine* that turns a high‑level signing configuration into a fully signed APK.  All higher‑level tools (e.g., the command‑line `apksigner`, the Gradle plugin, or any API consumer that signs an APK) instantiate this engine.  Without it, the rest of the `com.android.apksig` library would have nothing concrete to do with the signing configuration. |
| **Context and use case** | - **Typical flow**: A caller creates a `ApkSigner` instance, passes a list of `SignerConfig` objects (certificate/key pairs + options), and optionally a `SigningCertificateLineage` for source‑stamp.  The `ApkSigner` then creates a `DefaultApkSignerEngine` internally. <br>- **Input phase**: The caller feeds the engine the raw APK bytes (`initWith`) and each jar entry that is part of the APK (`inputJarEntry`).  The engine also receives the existing signing block (`inputApkSigningBlock`) if any. <br>- **Processing phase**: As entries are fed, the engine tracks whether a V1 signature is pending, whether a V2/V3 block needs to be written, and whether the output APK is already marked as debug‑gable. <br>- **Output phase**: After all entries have been processed, the caller calls `outputJarEntries` or `outputZipSections2` to obtain the signed output (either a new APK file or a `ZipOutputStream` for incremental signing). The engine then creates the V2/V3/V4 blocks, writes the V1 signatures, and optionally attaches a source‑stamp certificate. <br>- **Special cases**: <br>  * *Debug APKs*: if the output APK is debug‑gable but the config disallows it, `checkOutputApkNotDebuggableIfDebuggableMustBeRejected()` throws a `SignatureException`. <br>  * *Preserving other signatures*: the flag `mOtherSignersSignaturesPreserved` tells the engine to keep any existing signatures that don’t belong to the supplied signers. <br>  * *Source‑stamp*: `isEligibleForSourceStamp()` and `generateSourceStampCertificateDigest()` are used to produce a “source‑stamp” certificate that can be validated by tooling that needs to guarantee that the APK came from the original source. <br>- **Executor usage**: If performance is critical, a caller can set a `RunnablesExecutor` via `setExecutor`.  The engine will offload CPU‑intensive cryptographic operations (signature calculations, digesting) to that executor. <br>- **Closing**: The engine implements `Closeable/AutoCloseable`.  Once `close()` is called, it guarantees that no more signing work can be done and releases internal state. <br>In short, `DefaultApkSignerEngine` is the “bridge” that takes the cryptographic data supplied by a developer (keys, certificates, policy flags) and applies it to every relevant byte range of an APK, producing a fully compliant signed artifact.  All other classes in the `com.android.apksig` package (the builder classes, policy helpers, error‑handlers, etc.) rely on this engine to do the actual heavy lifting.