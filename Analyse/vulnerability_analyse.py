from tqdm import tqdm 
import json
from core.agent import call_agent_LLM
from tools.save import save_in_file
def vulnerability_analyse(jsonData, process=True):
    for data in tqdm(jsonData, desc="Analyse vulnérabilité", unit="class"):
        className = data["signature"]["name"] #  "name": "com.android.apksig.internal.apk.ApkSigningBlockUtils",
        package = data["signature"]["package"]
        path = "decompile/decompile-java/sources/" +package.replace(".","/") + "/" + className.split(".")[-1] +".java"
        with open(path, "r") as classes:
            code = classes.read()
            
        if code != "":
            #on a le code on peut lancer l'agent
            prompt = """
You are a security auditor specialized in static code analysis for Java applications. 
Your task is to analyze a full Java class source code and identify all potential security vulnerabilities, including but not limited to:

- Command injection
- Deserialization vulnerabilities
- Binary parsing errors
- Input validation issues
- Authentication/authorization bypass
- Unsafe cryptographic usage
- File system or OS access issues
- Any logic flaws that could lead to privilege escalation or remote code execution

Instructions:

1. Analyze the full class source code provided
2. Identify blocks of code that may be vulnerable
3. For each vulnerability, output:
   - Method name / code location
   - Type of vulnerability 
   - Short description of the vulnerability
   - Potential exploit scenario (what an attacker could do)
   - Severity (low, medium, high, critical)
   - Recommendation to fix the vulnerability
4. If a method or block has no security concerns, explicitly state: "Nothing to report in this method".
5. Only report real security concerns based on the code.
6. Be detailed and precise, use line numbers or code snippets when referring to vulnerability.

Format the output as JSON, for example:

{
  "class": "<ClassName>",
  "vulnerabilities": [
    {
      "method": "<methodName>",
      "lines": "<line numbers or snippet>",
      "type": "<type of vulnerability>",
      "description": "<what is wrong>",
      "exploit": "<how it could be exploited>",
      "severity": "<low|medium|high|critical>",
      "recommendation": "<how to fix>"
    },
    {
      "method": "<anotherMethod>",
      "lines": "<line numbers or snippet>",
      "type": "None",
      "description": "Nothing to report",
      "exploit": "N/A",
      "severity": "N/A",
      "recommendation": "N/A"
    }
  ]
}

Class source code (Java) is provided below. Analyze everything, including method implementations, field usages, and any interactions with sensitive data.

CODE TO ANALYSE :
""" + str(code)


            if process:
              res = call_agent_LLM(prompt,"qwen3-vl:32b")
              data["analyse_vulnerability"] = res
              save_in_file("vulnerability.json",json.dumps(jsonData, indent=2))
    return jsonData


